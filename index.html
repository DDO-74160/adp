<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üí∞ Argent de Poche - Famille (Sync)</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://cdn.emailjs.com/dist/email.min.js"></script>
    <style>
        body { 
            margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            background: linear-gradient(to bottom, #dbeafe, #e9d5ff);
            min-height: 100vh;
        }
        .sync-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
            padding: 8px 12px;
            border-radius: 20px;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }
        .sync-success { background: #10b981; }
        .sync-error { background: #ef4444; }
        .sync-syncing { background: #f59e0b; }
    </style>
</head>
<body>
    <div id="sync-status" class="sync-indicator" style="display: none;"></div>
    <div id="root">
        <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh;">
            <div style="text-align: center; padding: 2rem; background: white; border-radius: 1rem;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üí∞</div>
                <div style="font-size: 1.5rem;">Chargement de l'application...</div>
            </div>
        </div>
    </div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Configuration GitHub
        const GITHUB_CONFIG = {
            token: null,
            gistId: null,
            initialized: false
        };

        // Configuration EmailJS pour notifications
        const EMAIL_CONFIG = {
            serviceId: 'service_password_notify',
            templateId: 'template_password_change',
            publicKey: null,
            initialized: false
        };

        // Initialiser EmailJS
        const initEmailJS = () => {
            if (!EMAIL_CONFIG.publicKey) return false;
            try {
                emailjs.init(EMAIL_CONFIG.publicKey);
                EMAIL_CONFIG.initialized = true;
                return true;
            } catch (e) {
                console.error('Erreur initialisation EmailJS:', e);
                return false;
            }
        };

        // Envoyer notification changement de mot de passe
        const sendPasswordChangeNotification = async (oldPassword, newPassword, changedBy) => {
            if (!EMAIL_CONFIG.initialized) return false;

            const templateParams = {
                to_email: 'david.dimastro@gmail.com',
                from_name: 'Application Argent de Poche',
                changed_by: changedBy,
                change_date: new Date().toLocaleString('fr-FR'),
                old_password: oldPassword.length > 0 ? '‚óè'.repeat(oldPassword.length) : 'N/A',
                new_password: '‚óè'.repeat(newPassword.length),
                device_info: navigator.userAgent.includes('Mobile') ? 'Mobile' : 'Desktop'
            };

            try {
                await emailjs.send(
                    EMAIL_CONFIG.serviceId,
                    EMAIL_CONFIG.templateId,
                    templateParams
                );
                return true;
            } catch (error) {
                console.error('Erreur envoi email:', error);
                return false;
            }
        };

        // Fonctions de chiffrement/d√©chiffrement
        const encryptData = (data, password) => {
            return CryptoJS.AES.encrypt(JSON.stringify(data), password).toString();
        };

        const decryptData = (encryptedData, password) => {
            try {
                const bytes = CryptoJS.AES.decrypt(encryptedData, password);
                const decrypted = bytes.toString(CryptoJS.enc.Utf8);
                return JSON.parse(decrypted);
            } catch (e) {
                console.error('Erreur d√©chiffrement:', e);
                return null;
            }
        };

        // Fonctions de synchronisation GitHub
        const createGist = async (data, password) => {
            if (!GITHUB_CONFIG.token) return null;
            
            const encryptedData = encryptData(data, password);
            
            try {
                const response = await fetch('https://api.github.com/gists', {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${GITHUB_CONFIG.token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        description: 'Argent de poche - Donn√©es familiales (chiffr√©es)',
                        public: false,
                        files: {
                            'pocket-money-data.json': {
                                content: encryptedData
                            }
                        }
                    })
                });
                
                if (response.ok) {
                    const gist = await response.json();
                    GITHUB_CONFIG.gistId = gist.id;
                    localStorage.setItem('github_gist_id', gist.id);
                    return gist.id;
                }
            } catch (e) {
                console.error('Erreur cr√©ation Gist:', e);
            }
            return null;
        };

        const updateGist = async (data, password) => {
            if (!GITHUB_CONFIG.token || !GITHUB_CONFIG.gistId) return false;
            
            const encryptedData = encryptData(data, password);
            
            try {
                const response = await fetch(`https://api.github.com/gists/${GITHUB_CONFIG.gistId}`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `token ${GITHUB_CONFIG.token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        files: {
                            'pocket-money-data.json': {
                                content: encryptedData
                            }
                        }
                    })
                });
                
                return response.ok;
            } catch (e) {
                console.error('Erreur mise √† jour Gist:', e);
                return false;
            }
        };

        const loadFromGist = async (password) => {
            if (!GITHUB_CONFIG.token || !GITHUB_CONFIG.gistId) return null;
            
            try {
                const response = await fetch(`https://api.github.com/gists/${GITHUB_CONFIG.gistId}`, {
                    headers: {
                        'Authorization': `token ${GITHUB_CONFIG.token}`,
                    }
                });
                
                if (response.ok) {
                    const gist = await response.json();
                    const encryptedContent = gist.files['pocket-money-data.json'].content;
                    return decryptData(encryptedContent, password);
                }
            } catch (e) {
                console.error('Erreur chargement Gist:', e);
            }
            return null;
        };

        const PocketMoneyApp = () => {
          const [currentUser, setCurrentUser] = useState(null);
          const [children, setChildren] = useState([
            { id: 1, name: 'Thomas', balance: 0, avatar: 'üßë‚Äçü¶±', age: '12 ans (a√Æn√©)', color: 'from-blue-500 to-cyan-500' },
            { id: 2, name: 'Cl√©ment', balance: 0, avatar: 'üë¶', age: '10 ans (cadet)', color: 'from-green-500 to-emerald-500' }
          ]);
          const [transactions, setTransactions] = useState([]);
          const [showAddMoney, setShowAddMoney] = useState(false);
          const [showExpense, setShowExpense] = useState(false);
          const [selectedChild, setSelectedChild] = useState(null);
          const [amount, setAmount] = useState('');
          const [description, setDescription] = useState('');
          const [showHistory, setShowHistory] = useState(false);
          const [historyChild, setHistoryChild] = useState(null);
          const [showPasswordModal, setShowPasswordModal] = useState(false);
          const [pendingUser, setPendingUser] = useState(null);
          const [password, setPassword] = useState('');
          const [passwordError, setPasswordError] = useState('');
          const [showChangePassword, setShowChangePassword] = useState(false);
          const [newPassword, setNewPassword] = useState('');
          const [confirmPassword, setConfirmPassword] = useState('');
          const [changePasswordError, setChangePasswordError] = useState('');
          const [showSyncSetup, setShowSyncSetup] = useState(false);
          const [githubToken, setGithubToken] = useState('');
          const [syncStatus, setSyncStatus] = useState('idle');
          const [lastSyncTime, setLastSyncTime] = useState(null);
          const [showEmailSetup, setShowEmailSetup] = useState(false);
          const [emailJsKey, setEmailJsKey] = useState('');

          const syncIntervalRef = useRef(null);

          // R√©cup√©rer le mot de passe stock√© ou utiliser le d√©faut
          const [storedPassword, setStoredPassword] = useState(() => {
            return localStorage.getItem('pocketMoney_password') || '1234';
          });

          const users = [
            { id: 'papa', name: 'üë® Papa', role: 'parent' },
            { id: 'maman', name: 'üë© Maman', role: 'parent' },
            { id: 'thomas', name: 'üßë‚Äçü¶± Thomas', role: 'child' },
            { id: 'clement', name: 'üë¶ Cl√©ment', role: 'child' }
          ];

          // Afficher le statut de sync
          const showSyncStatus = (status, message) => {
            setSyncStatus(status);
            const indicator = document.getElementById('sync-status');
            if (indicator) {
                indicator.style.display = 'block';
                indicator.className = `sync-indicator sync-${status}`;
                indicator.textContent = message;
                
                if (status === 'success' || status === 'error') {
                    setTimeout(() => {
                        indicator.style.display = 'none';
                    }, 3000);
                }
            }
          };

          // Sauvegarder dans GitHub
          const saveToGitHub = async () => {
            if (!GITHUB_CONFIG.initialized || !GITHUB_CONFIG.token) return;
            
            showSyncStatus('syncing', 'üîÑ Synchronisation...');
            
            const dataToSync = {
                children,
                transactions,
                password: storedPassword,
                lastUpdate: new Date().toISOString()
            };

            let success = false;
            if (GITHUB_CONFIG.gistId) {
                success = await updateGist(dataToSync, storedPassword);
            } else {
                const gistId = await createGist(dataToSync, storedPassword);
                success = !!gistId;
            }

            if (success) {
                setLastSyncTime(new Date().toLocaleTimeString('fr-FR'));
                showSyncStatus('success', '‚úÖ Synchronis√©');
            } else {
                showSyncStatus('error', '‚ùå Erreur sync');
            }
          };

          // Charger depuis GitHub
          const loadFromGitHub = async () => {
            if (!GITHUB_CONFIG.initialized || !GITHUB_CONFIG.token) return;
            
            const data = await loadFromGist(storedPassword);
            if (data) {
                setChildren(data.children || children);
                setTransactions(data.transactions || []);
                if (data.password) {
                    setStoredPassword(data.password);
                    localStorage.setItem('pocketMoney_password', data.password);
                }
                setLastSyncTime(new Date().toLocaleTimeString('fr-FR'));
                showSyncStatus('success', '‚úÖ Donn√©es charg√©es');
            }
          };

          // Configuration EmailJS
          const setupEmailNotifications = () => {
            if (!emailJsKey || emailJsKey.length < 10) {
              alert('‚ùå Cl√© EmailJS invalide. Doit √™tre fournie par configuration.');
              return;
            }

            EMAIL_CONFIG.publicKey = emailJsKey;
            localStorage.setItem('emailjs_public_key', emailJsKey);
            
            const initialized = initEmailJS();
            
            setShowEmailSetup(false);
            setEmailJsKey('');
            
            if (initialized) {
              alert('‚úÖ Notifications email activ√©es !\nüìß Vous recevrez un email √† chaque changement de mot de passe.');
            } else {
              alert('‚ùå Erreur lors de l\'activation des notifications email.');
            }
          };
          const setupGitHubSync = () => {
            if (!githubToken.startsWith('ghp_')) {
                alert('‚ùå Token GitHub invalide. Il doit commencer par "ghp_"');
                return;
            }

            GITHUB_CONFIG.token = githubToken;
            GITHUB_CONFIG.gistId = localStorage.getItem('github_gist_id');
            GITHUB_CONFIG.initialized = true;

            localStorage.setItem('github_token', githubToken);
            
            setShowSyncSetup(false);
            setGithubToken('');
            
            // D√©marrer la synchronisation
            startSyncInterval();
            loadFromGitHub();
            
            alert('‚úÖ Synchronisation GitHub activ√©e !');
          };

          // D√©marrer la synchronisation p√©riodique
          const startSyncInterval = () => {
            if (syncIntervalRef.current) {
                clearInterval(syncIntervalRef.current);
            }
            
            syncIntervalRef.current = setInterval(() => {
                if (GITHUB_CONFIG.initialized) {
                    loadFromGitHub();
                }
            }, 30000); // Sync toutes les 30 secondes
          };

          // Charger les donn√©es au d√©marrage
          useEffect(() => {
            try {
              const savedChildren = localStorage.getItem('pocketMoney_children');
              const savedTransactions = localStorage.getItem('pocketMoney_transactions');
              const savedToken = localStorage.getItem('github_token');
              const savedGistId = localStorage.getItem('github_gist_id');
              const savedEmailKey = localStorage.getItem('emailjs_public_key');
              
              if (savedChildren) {
                setChildren(JSON.parse(savedChildren));
              }
              
              if (savedTransactions) {
                setTransactions(JSON.parse(savedTransactions));
              }

              // Configuration GitHub si d√©j√† configur√©e
              if (savedToken) {
                GITHUB_CONFIG.token = savedToken;
                GITHUB_CONFIG.gistId = savedGistId;
                GITHUB_CONFIG.initialized = true;
                startSyncInterval();
                loadFromGitHub();
              }

              // Configuration EmailJS si d√©j√† configur√©e
              if (savedEmailKey) {
                EMAIL_CONFIG.publicKey = savedEmailKey;
                initEmailJS();
              }
            } catch (e) {
              console.log('Premier chargement');
            }
          }, []);

          // Sauvegarder automatiquement les changements
          useEffect(() => {
            try {
              localStorage.setItem('pocketMoney_children', JSON.stringify(children));
              if (GITHUB_CONFIG.initialized) {
                saveToGitHub();
              }
            } catch (e) {
              console.error('Erreur sauvegarde enfants:', e);
            }
          }, [children]);

          useEffect(() => {
            try {
              localStorage.setItem('pocketMoney_transactions', JSON.stringify(transactions));
              if (GITHUB_CONFIG.initialized) {
                saveToGitHub();
              }
            } catch (e) {
              console.error('Erreur sauvegarde transactions:', e);
            }
          }, [transactions]);

          // Nettoyage
          useEffect(() => {
            return () => {
              if (syncIntervalRef.current) {
                clearInterval(syncIntervalRef.current);
              }
            };
          }, []);

          const handleUserLogin = (user) => {
            if (user.role === 'parent') {
              setPendingUser(user);
              setShowPasswordModal(true);
              setPassword('');
              setPasswordError('');
            } else {
              setCurrentUser(user);
            }
          };

          const handlePasswordSubmit = () => {
            if (password === storedPassword) {
              setCurrentUser(pendingUser);
              setShowPasswordModal(false);
              setPendingUser(null);
              setPassword('');
              setPasswordError('');
            } else {
              setPasswordError('Mot de passe incorrect');
              setPassword('');
            }
          };

          const handleChangePassword = async () => {
            if (newPassword.length < 4) {
              setChangePasswordError('Le mot de passe doit faire au moins 4 caract√®res');
              return;
            }
            if (newPassword !== confirmPassword) {
              setChangePasswordError('Les mots de passe ne correspondent pas');
              return;
            }
            
            const oldPassword = storedPassword;
            
            // Envoyer notification email
            if (EMAIL_CONFIG.initialized) {
                const emailSent = await sendPasswordChangeNotification(
                    oldPassword, 
                    newPassword, 
                    currentUser.name
                );
                if (emailSent) {
                    console.log('‚úÖ Notification email envoy√©e');
                } else {
                    console.log('‚ö†Ô∏è Erreur envoi notification email');
                }
            }
            
            setStoredPassword(newPassword);
            localStorage.setItem('pocketMoney_password', newPassword);
            setShowChangePassword(false);
            setNewPassword('');
            setConfirmPassword('');
            setChangePasswordError('');
            
            if (GITHUB_CONFIG.initialized) {
              await saveToGitHub();
            }
            
            alert('‚úÖ Mot de passe modifi√© avec succ√®s !' + 
                  (EMAIL_CONFIG.initialized ? '\nüìß Notification envoy√©e par email.' : ''));
          };

          const addTransaction = (childId, amount, type, description) => {
            const child = children.find(c => c.id === childId);
            const newTransaction = {
              id: Date.now(),
              childId,
              childName: child.name,
              amount: parseFloat(amount),
              type,
              description,
              date: new Date().toLocaleDateString('fr-FR'),
              time: new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }),
              addedBy: currentUser.name,
              timestamp: new Date().toLocaleString('fr-FR', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric',
                hour: '2-digit', 
                minute: '2-digit'
              })
            };

            setTransactions(prev => [newTransaction, ...prev]);
            
            setChildren(prev => prev.map(child => 
              child.id === childId 
                ? { ...child, balance: type === 'add' ? child.balance + parseFloat(amount) : child.balance - parseFloat(amount) }
                : child
            ));
          };

          const handleAddMoney = () => {
            if (selectedChild && amount) {
              addTransaction(selectedChild.id, amount, 'add', description || 'Argent de poche mensuel');
              setShowAddMoney(false);
              setAmount('');
              setDescription('');
              setSelectedChild(null);
            }
          };

          const handleExpense = () => {
            if (selectedChild && amount) {
              addTransaction(selectedChild.id, amount, 'expense', description || 'Achat');
              setShowExpense(false);
              setAmount('');
              setDescription('');
              setSelectedChild(null);
            }
          };

          const resetChildData = (childId) => {
            const child = children.find(c => c.id === childId);
            if (window.confirm(`‚ö†Ô∏è √ätes-vous s√ªr de vouloir remettre √† z√©ro le compte de ${child.name} et son historique ?`)) {
              setChildren(prev => prev.map(c => 
                c.id === childId ? { ...c, balance: 0 } : c
              ));
              setTransactions(prev => prev.filter(t => t.childId !== childId));
            }
          };

          const resetAllData = () => {
            if (window.confirm('‚ö†Ô∏è √ätes-vous s√ªr de vouloir remettre √† z√©ro TOUS les comptes et l\'historique ?')) {
              const resetChildren = children.map(child => ({ ...child, balance: 0 }));
              setChildren(resetChildren);
              setTransactions([]);
            }
          };

          const getChildTransactions = (childId) => {
            return transactions.filter(t => t.childId === childId);
          };

          const getCurrentUserChild = () => {
            if (currentUser.id === 'thomas') return children.find(c => c.name === 'Thomas');
            if (currentUser.id === 'clement') return children.find(c => c.name === 'Cl√©ment');
            return null;
          };

          // Modal de configuration EmailJS
          if (showEmailSetup) {
            return (
              <div className="min-h-screen bg-gradient-to-b from-blue-100 to-purple-100 p-4 flex items-center justify-center">
                <div className="bg-white rounded-3xl shadow-lg p-8 w-full max-w-sm">
                  <div className="text-center mb-6">
                    <div className="text-4xl mb-4">üìß</div>
                    <h2 className="text-xl font-bold text-gray-800 mb-2">Notifications Email</h2>
                    <p className="text-gray-600 text-sm">Changements de mot de passe ‚Üí david.dimastro@gmail.com</p>
                  </div>

                  <div className="mb-4 p-3 bg-blue-50 rounded-2xl text-sm text-blue-700">
                    <p className="font-bold mb-2">üîß Configuration automatique :</p>
                    <p>Les notifications email sont pr√©configur√©es pour envoyer un email √† david.dimastro@gmail.com √† chaque changement de mot de passe.</p>
                  </div>

                  <input
                    type="password"
                    placeholder="Cl√© EmailJS (fournie par admin)"
                    value={emailJsKey}
                    onChange={(e) => setEmailJsKey(e.target.value)}
                    className="w-full p-3 border border-gray-300 rounded-2xl mb-4 text-sm"
                  />

                  <div className="flex space-x-3">
                    <button
                      onClick={() => setShowEmailSetup(false)}
                      className="flex-1 bg-gray-200 text-gray-800 p-3 rounded-2xl font-medium"
                    >
                      Plus tard
                    </button>
                    <button
                      onClick={setupEmailNotifications}
                      className="flex-1 bg-green-500 text-white p-3 rounded-2xl font-medium"
                    >
                      Activer
                    </button>
                  </div>

                  <div className="mt-4 p-3 bg-green-50 rounded-2xl text-xs text-green-700 text-center">
                    <p>üîê Email automatique √† chaque changement de mot de passe</p>
                  </div>
                </div>
              </div>
            );
          }
          if (showSyncSetup) {
            return (
              <div className="min-h-screen bg-gradient-to-b from-blue-100 to-purple-100 p-4 flex items-center justify-center">
                <div className="bg-white rounded-3xl shadow-lg p-8 w-full max-w-sm">
                  <div className="text-center mb-6">
                    <div className="text-4xl mb-4">üîó</div>
                    <h2 className="text-xl font-bold text-gray-800 mb-2">Configuration GitHub</h2>
                    <p className="text-gray-600 text-sm">Synchronisation automatique entre t√©l√©phones</p>
                  </div>

                  <div className="mb-4 p-3 bg-blue-50 rounded-2xl text-sm text-blue-700">
                    <p className="font-bold mb-2">üìù Instructions :</p>
                    <p>1. Allez sur github.com/settings/tokens</p>
                    <p>2. "Generate new token (classic)"</p>
                    <p>3. Cochez "gist"</p>
                    <p>4. Copiez le token ici</p>
                  </div>

                  <input
                    type="password"
                    placeholder="Token GitHub (ghp_...)"
                    value={githubToken}
                    onChange={(e) => setGithubToken(e.target.value)}
                    className="w-full p-3 border border-gray-300 rounded-2xl mb-4 text-sm"
                  />

                  <div className="flex space-x-3">
                    <button
                      onClick={() => setShowSyncSetup(false)}
                      className="flex-1 bg-gray-200 text-gray-800 p-3 rounded-2xl font-medium"
                    >
                      Plus tard
                    </button>
                    <button
                      onClick={setupGitHubSync}
                      className="flex-1 bg-blue-500 text-white p-3 rounded-2xl font-medium"
                    >
                      Activer
                    </button>
                  </div>

                  <div className="mt-4 p-3 bg-green-50 rounded-2xl text-xs text-green-700 text-center">
                    <p>üîí Vos donn√©es seront chiffr√©es avec votre mot de passe</p>
                  </div>
                </div>
              </div>
            );
          }

          // Modal de changement de mot de passe
          if (showChangePassword) {
            return (
              <div className="min-h-screen bg-gradient-to-b from-blue-100 to-purple-100 p-4 flex items-center justify-center">
                <div className="bg-white rounded-3xl shadow-lg p-8 w-full max-w-sm">
                  <div className="text-center mb-6">
                    <div className="text-4xl mb-4">üîë</div>
                    <h2 className="text-xl font-bold text-gray-800 mb-2">Changer le mot de passe</h2>
                    <p className="text-gray-600">Nouveau mot de passe parents</p>
                  </div>

                  <input
                    type="password"
                    placeholder="Nouveau mot de passe"
                    value={newPassword}
                    onChange={(e) => setNewPassword(e.target.value)}
                    className="w-full p-3 border border-gray-300 rounded-2xl mb-4 text-lg"
                  />

                  <input
                    type="password"
                    placeholder="Confirmer le mot de passe"
                    value={confirmPassword}
                    onChange={(e) => setConfirmPassword(e.target.value)}
                    className="w-full p-3 border border-gray-300 rounded-2xl mb-4 text-lg"
                  />

                  {changePasswordError && (
                    <p className="text-red-500 text-sm text-center mb-4">{changePasswordError}</p>
                  )}

                  <div className="flex space-x-3">
                    <button
                      onClick={() => {
                        setShowChangePassword(false);
                        setNewPassword('');
                        setConfirmPassword('');
                        setChangePasswordError('');
                      }}
                      className="flex-1 bg-gray-200 text-gray-800 p-3 rounded-2xl font-medium"
                    >
                      Annuler
                    </button>
                    <button
                      onClick={handleChangePassword}
                      className="flex-1 bg-blue-500 text-white p-3 rounded-2xl font-medium"
                    >
                      Modifier
                    </button>
                  </div>
                </div>
              </div>
            );
          }

          // Modal de mot de passe
          if (showPasswordModal && pendingUser) {
            return (
              <div className="min-h-screen bg-gradient-to-b from-blue-100 to-purple-100 p-4 flex items-center justify-center">
                <div className="bg-white rounded-3xl shadow-lg p-8 w-full max-w-sm">
                  <div className="text-center mb-6">
                    <div className="text-4xl mb-4">üîí</div>
                    <h2 className="text-xl font-bold text-gray-800 mb-2">Acc√®s Parent</h2>
                    <p className="text-gray-600">Connexion pour {pendingUser.name}</p>
                  </div>

                  <input
                    type="password"
                    placeholder="Mot de passe"
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    onKeyPress={(e) => e.key === 'Enter' && handlePasswordSubmit()}
                    className="w-full p-4 border border-gray-300 rounded-2xl mb-4 text-lg text-center"
                    autoFocus
                  />

                  {passwordError && (
                    <p className="text-red-500 text-sm text-center mb-4">{passwordError}</p>
                  )}

                  <div className="flex space-x-3">
                    <button
                      onClick={() => {
                        setShowPasswordModal(false);
                        setPendingUser(null);
                        setPassword('');
                        setPasswordError('');
                      }}
                      className="flex-1 bg-gray-200 text-gray-800 p-3 rounded-2xl font-medium"
                    >
                      Annuler
                    </button>
                    <button
                      onClick={handlePasswordSubmit}
                      className="flex-1 bg-blue-500 text-white p-3 rounded-2xl font-medium"
                    >
                      Valider
                    </button>
                  </div>

                  <div className="mt-6 p-3 bg-blue-50 rounded-2xl text-center">
                    <p className="text-xs text-blue-700">
                      üí° Les enfants n'ont pas besoin de mot de passe
                    </p>
                  </div>
                </div>
              </div>
            );
          }

          if (!currentUser) {
            return (
              <div className="min-h-screen bg-gradient-to-b from-blue-100 to-purple-100 p-4">
                <div className="max-w-md mx-auto">
                  <div className="bg-white rounded-3xl shadow-lg p-8 mt-8">
                    <div className="text-center mb-8">
                      <div className="text-6xl mb-4">üí∞</div>
                      <h1 className="text-2xl font-bold text-gray-800 mb-2">Argent de Poche</h1>
                      <p className="text-gray-600">Qui √™tes-vous ?</p>
                      {GITHUB_CONFIG.initialized && lastSyncTime && (
                        <p className="text-xs text-green-600 mt-2">üîó Derni√®re sync: {lastSyncTime}</p>
                      )}
                    </div>
                    
                    <div className="space-y-3">
                      {users.map(user => (
                        <button
                          key={user.id}
                          onClick={() => handleUserLogin(user)}
                          className="w-full p-4 bg-gradient-to-r from-blue-500 to-purple-500 text-white rounded-2xl font-medium text-lg shadow-md hover:shadow-lg transform hover:scale-105 transition-all flex items-center justify-center space-x-2"
                        >
                          <span>{user.name}</span>
                          {user.role === 'parent' && <span className="text-sm">üîí</span>}
                        </button>
                      ))}
                    </div>

                    <div className="mt-6 space-y-3">
                      {!GITHUB_CONFIG.initialized && (
                        <button
                          onClick={() => setShowSyncSetup(true)}
                          className="w-full bg-green-500 text-white p-3 rounded-2xl font-medium flex items-center justify-center space-x-2"
                        >
                          <span>üîó</span>
                          <span>Activer la synchronisation</span>
                        </button>
                      )}
                      
                      {!EMAIL_CONFIG.initialized && (
                        <button
                          onClick={() => setShowEmailSetup(true)}
                          className="w-full bg-blue-500 text-white p-3 rounded-2xl font-medium flex items-center justify-center space-x-2"
                        >
                          <span>üìß</span>
                          <span>Activer les notifications email</span>
                        </button>
                      )}
                    </div>

                    <div className="mt-8 p-4 bg-blue-50 rounded-2xl">
                      <h3 className="font-bold text-blue-800 mb-2">üöÄ Fonctionnalit√©s avanc√©es :</h3>
                      <div className="text-sm text-blue-700 space-y-1">
                        <p><strong>üîó Synchronisation GitHub :</strong> Partag√© entre tous vos t√©l√©phones</p>
                        <p><strong>üìß Notifications Email :</strong> Changements de mot de passe ‚Üí david.dimastro@gmail.com</p>
                        <p><strong>üîí S√©curis√© :</strong> Donn√©es chiffr√©es avec votre mot de passe</p>
                        <p><strong>üîÑ Automatique :</strong> Sync toutes les 30 secondes</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            );
          }

          // Vue enfant - ne voit que son propre compte
          if (currentUser.role === 'child') {
            const myAccount = getCurrentUserChild();
            if (!myAccount) return <div>Erreur: Compte non trouv√©</div>;

            const myTransactions = getChildTransactions(myAccount.id);

            return (
              <div className="min-h-screen bg-gradient-to-b from-blue-100 to-purple-100 p-4">
                <div className="max-w-md mx-auto">
                  {/* Header enfant */}
                  <div className="flex items-center justify-between mb-6 bg-white rounded-2xl p-4 shadow-md">
                    <div>
                      <p className="text-sm text-gray-600">Mon compte</p>
                      <p className="font-bold text-lg flex items-center">
                        {currentUser.name}
                      </p>
                      {GITHUB_CONFIG.initialized && lastSyncTime && (
                        <p className="text-xs text-green-600">üîó Sync: {lastSyncTime}</p>
                      )}
                    </div>
                    <button 
                      onClick={() => setCurrentUser(null)}
                      className="bg-gray-100 p-2 rounded-full hover:bg-gray-200"
                    >
                      üë§
                    </button>
                  </div>

                  {/* Mon solde */}
                  <div className="bg-white rounded-3xl shadow-lg p-6 mb-6">
                    <div className="text-center mb-4">
                      <h2 className="text-2xl font-bold flex items-center justify-center">
                        <span className="text-4xl mr-3">{myAccount.avatar}</span>
                        <div>
                          <div>{myAccount.name}</div>
                          <div className="text-sm text-gray-500 font-normal">{myAccount.age}</div>
                        </div>
                      </h2>
                    </div>
                    
                    <div className={`bg-gradient-to-r ${myAccount.color} text-white rounded-2xl p-6 text-center`}>
                      <p className="text-sm opacity-90">Mon argent de poche</p>
                      <p className="text-4xl font-bold">{myAccount.balance.toFixed(2)} ‚Ç¨</p>
                    </div>
                  </div>

                  {/* Mon historique */}
                  <div className="bg-white rounded-3xl shadow-lg p-6">
                    <h3 className="text-lg font-bold mb-4">üìö Mes achats</h3>
                    
                    {myTransactions.length === 0 ? (
                      <p className="text-gray-500 text-center py-8">Aucun achat pour le moment</p>
                    ) : (
                      <div className="space-y-3 max-h-96 overflow-y-auto">
                        {myTransactions.map(transaction => (
                          <div key={transaction.id} className="p-4 border rounded-2xl">
                            <div className="flex justify-between items-start">
                              <div className="flex-1">
                                <p className="font-medium">{transaction.description}</p>
                                <p className="text-sm text-gray-600">
                                  üìÖ {transaction.timestamp}
                                </p>
                              </div>
                              <div className="text-right">
                                <p className={`font-bold ${transaction.type === 'add' ? 'text-green-600' : 'text-red-600'}`}>
                                  {transaction.type === 'add' ? '+' : '-'}{transaction.amount.toFixed(2)} ‚Ç¨
                                </p>
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              </div>
            );
          }

          // Vue historique
          if (showHistory && historyChild) {
            const childTransactions = getChildTransactions(historyChild.id);
            return (
              <div className="min-h-screen bg-gradient-to-b from-blue-100 to-purple-100 p-4">
                <div className="max-w-md mx-auto">
                  <div className="bg-white rounded-3xl shadow-lg p-6">
                    <div className="flex items-center justify-between mb-6">
                      <button 
                        onClick={() => setShowHistory(false)}
                        className="text-blue-500 font-medium"
                      >
                        ‚Üê Retour
                      </button>
                      <h2 className="text-xl font-bold">{historyChild.avatar} {historyChild.name}</h2>
                      <button 
                        onClick={() => setCurrentUser(null)}
                        className="text-gray-500 text-sm"
                      >
                        üè† Accueil
                      </button>
                    </div>

                    <div className={`mb-6 p-4 bg-gradient-to-r ${historyChild.color} text-white rounded-2xl text-center`}>
                      <p className="text-sm opacity-90">Solde disponible</p>
                      <p className="text-2xl font-bold">{historyChild.balance.toFixed(2)} ‚Ç¨</p>
                      <p className="text-xs opacity-75">{historyChild.age}</p>
                    </div>

                    {/* Reset individuel pour les parents */}
                    {currentUser.role === 'parent' && (
                      <button
                        onClick={() => resetChildData(historyChild.id)}
                        className="w-full bg-orange-500 text-white p-3 rounded-2xl font-medium mb-4 flex items-center justify-center space-x-2"
                      >
                        <span>üîÑ</span>
                        <span>Remettre √† z√©ro ce compte</span>
                      </button>
                    )}

                    <h3 className="text-lg font-bold mb-4">üìö Historique des transactions</h3>
                    
                    {childTransactions.length === 0 ? (
                      <p className="text-gray-500 text-center py-8">Aucune transaction pour le moment</p>
                    ) : (
                      <div className="space-y-3 max-h-96 overflow-y-auto">
                        {childTransactions.map(transaction => (
                          <div key={transaction.id} className="p-4 border rounded-2xl">
                            <div className="flex justify-between items-start">
                              <div className="flex-1">
                                <p className="font-medium">{transaction.description}</p>
                                <p className="text-sm text-gray-600">
                                  üìÖ {transaction.timestamp}
                                </p>
                                <p className="text-xs text-gray-500">Saisi par {transaction.addedBy}</p>
                              </div>
                              <div className="text-right">
                                <p className={`font-bold ${transaction.type === 'add' ? 'text-green-600' : 'text-red-600'}`}>
                                  {transaction.type === 'add' ? '+' : '-'}{transaction.amount.toFixed(2)} ‚Ç¨
                                </p>
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              </div>
            );
          }

          // Vue parents - voient tout
          return (
            <div className="min-h-screen bg-gradient-to-b from-blue-100 to-purple-100 p-4">
              <div className="max-w-md mx-auto">
                {/* Header */}
                <div className="flex items-center justify-between mb-6 bg-white rounded-2xl p-4 shadow-md">
                  <div>
                    <p className="text-sm text-gray-600">Connect√© en tant que</p>
                    <p className="font-bold text-lg flex items-center">
                      {currentUser.name}
                      <span className="ml-2 text-blue-500">üîí</span>
                    </p>
                    {GITHUB_CONFIG.initialized && lastSyncTime && (
                      <p className="text-xs text-green-600">üîó Derni√®re sync: {lastSyncTime}</p>
                    )}
                  </div>
                  <div className="flex space-x-2">
                    {!GITHUB_CONFIG.initialized && (
                      <button 
                        onClick={() => setShowSyncSetup(true)}
                        className="bg-green-100 p-2 rounded-full hover:bg-green-200" 
                        title="Activer synchronisation"
                      >
                        üîó
                      </button>
                    )}
                    {!EMAIL_CONFIG.initialized && (
                      <button 
                        onClick={() => setShowEmailSetup(true)}
                        className="bg-blue-100 p-2 rounded-full hover:bg-blue-200" 
                        title="Activer notifications email"
                      >
                        üìß
                      </button>
                    )}
                    <button 
                      onClick={() => setShowChangePassword(true)}
                      className="bg-yellow-100 p-2 rounded-full hover:bg-yellow-200" 
                      title="Changer mot de passe"
                    >
                      üîë
                    </button>
                    <button 
                      onClick={() => setCurrentUser(null)}
                      className="bg-gray-100 p-2 rounded-full hover:bg-gray-200"
                    >
                      üë§
                    </button>
                  </div>
                </div>

                {/* Badge de synchronisation et notifications */}
                <div className="space-y-2 mb-4">
                  <div className={`${GITHUB_CONFIG.initialized ? 'bg-green-100 border-green-300' : 'bg-yellow-100 border-yellow-300'} border rounded-2xl p-3 text-center`}>
                    <p className={`text-sm ${GITHUB_CONFIG.initialized ? 'text-green-700' : 'text-yellow-700'}`}>
                      {GITHUB_CONFIG.initialized ? 'üîó Synchronisation GitHub activ√©e' : '‚ö†Ô∏è Synchronisation GitHub d√©sactiv√©e'}
                    </p>
                  </div>
                  
                  <div className={`${EMAIL_CONFIG.initialized ? 'bg-blue-100 border-blue-300' : 'bg-gray-100 border-gray-300'} border rounded-2xl p-3 text-center`}>
                    <p className={`text-sm ${EMAIL_CONFIG.initialized ? 'text-blue-700' : 'text-gray-600'}`}>
                      {EMAIL_CONFIG.initialized ? 'üìß Notifications email activ√©es' : 'üìß Notifications email d√©sactiv√©es'}
                    </p>
                  </div>
                </div>

                {/* Comptes des enfants */}
                <div className="space-y-4 mb-6">
                  {children.map(child => (
                    <div key={child.id} className="bg-white rounded-3xl shadow-lg p-6">
                      <div className="flex items-center justify-between mb-4">
                        <h3 className="text-xl font-bold flex items-center">
                          <span className="text-3xl mr-3">{child.avatar}</span>
                          <div>
                            <div>{child.name}</div>
                            <div className="text-sm text-gray-500 font-normal">{child.age}</div>
                          </div>
                        </h3>
                        <button
                          onClick={() => {
                            setHistoryChild(child);
                            setShowHistory(true);
                          }}
                          className="bg-blue-100 p-2 rounded-full hover:bg-blue-200"
                          title="Voir l'historique"
                        >
                          üìä
                        </button>
                      </div>
                      
                      <div className={`bg-gradient-to-r ${child.color} text-white rounded-2xl p-4 mb-4`}>
                        <p className="text-sm opacity-90">Solde disponible</p>
                        <p className="text-3xl font-bold">{child.balance.toFixed(2)} ‚Ç¨</p>
                      </div>

                      <div className="flex space-x-3 mb-3">
                        <button
                          onClick={() => {
                            setSelectedChild(child);
                            setShowAddMoney(true);
                          }}
                          className="flex-1 bg-green-500 text-white p-3 rounded-2xl font-medium flex items-center justify-center space-x-2 hover:bg-green-600"
                        >
                          <span>‚ûï</span>
                          <span>Ajouter</span>
                        </button>
                        <button
                          onClick={() => {
                            setSelectedChild(child);
                            setShowExpense(true);
                          }}
                          className="flex-1 bg-red-500 text-white p-3 rounded-2xl font-medium flex items-center justify-center space-x-2 hover:bg-red-600"
                        >
                          <span>‚ûñ</span>
                          <span>D√©pense</span>
                        </button>
                      </div>

                      {/* Reset individuel */}
                      <button
                        onClick={() => resetChildData(child.id)}
                        className="w-full bg-orange-400 text-white p-2 rounded-xl text-sm font-medium flex items-center justify-center space-x-1 hover:bg-orange-500"
                      >
                        <span>üîÑ</span>
                        <span>Reset {child.name}</span>
                      </button>

                      {/* Recent transactions preview */}
                      <div className="mt-4">
                        {getChildTransactions(child.id).slice(0, 2).map(transaction => (
                          <div key={transaction.id} className="flex justify-between items-center py-2 text-sm border-t">
                            <span className="truncate flex-1 mr-2">{transaction.description}</span>
                            <span className={transaction.type === 'add' ? 'text-green-600 font-medium' : 'text-red-600 font-medium'}>
                              {transaction.type === 'add' ? '+' : '-'}{transaction.amount.toFixed(2)}‚Ç¨
                            </span>
                          </div>
                        ))}
                        {getChildTransactions(child.id).length === 0 && (
                          <p className="text-gray-400 text-sm italic text-center py-2">Aucune transaction</p>
                        )}
                      </div>
                    </div>
                  ))}
                </div>

                {/* Reset g√©n√©ral */}
                <button
                  onClick={resetAllData}
                  className="w-full bg-red-600 text-white p-4 rounded-2xl font-medium flex items-center justify-center space-x-2 hover:bg-red-700 mb-4"
                >
                  <span>‚ö†Ô∏è</span>
                  <span>Remise √† z√©ro G√âN√âRALE</span>
                </button>

                {/* Add Money Modal */}
                {showAddMoney && selectedChild && (
                  <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-3xl p-6 w-full max-w-sm">
                      <h3 className="text-xl font-bold mb-4 text-center">üí∞ Ajouter de l'argent</h3>
                      <p className="text-gray-600 mb-4 text-center">Pour {selectedChild.avatar} {selectedChild.name}</p>
                      
                      <input
                        type="number"
                        step="0.01"
                        placeholder="Montant (‚Ç¨)"
                        value={amount}
                        onChange={(e) => setAmount(e.target.value)}
                        className="w-full p-3 border border-gray-300 rounded-2xl mb-4 text-lg"
                      />
                      
                      <input
                        type="text"
                        placeholder="Description (optionnel)"
                        value={description}
                        onChange={(e) => setDescription(e.target.value)}
                        className="w-full p-3 border border-gray-300 rounded-2xl mb-6"
                      />
                      
                      <div className="flex space-x-3">
                        <button
                          onClick={() => setShowAddMoney(false)}
                          className="flex-1 bg-gray-200 text-gray-800 p-3 rounded-2xl font-medium"
                        >
                          Annuler
                        </button>
                        <button
                          onClick={handleAddMoney}
                          className="flex-1 bg-green-500 text-white p-3 rounded-2xl font-medium"
                        >
                          Confirmer
                        </button>
                      </div>
                    </div>
                  </div>
                )}

                {/* Expense Modal */}
                {showExpense && selectedChild && (
                  <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                    <div className="bg-white rounded-3xl p-6 w-full max-w-sm">
                      <h3 className="text-xl font-bold mb-4 text-center">üõí Enregistrer une d√©pense</h3>
                      <p className="text-gray-600 mb-4 text-center">Pour {selectedChild.avatar} {selectedChild.name}</p>
                      
                      <input
                        type="number"
                        step="0.01"
                        placeholder="Montant (‚Ç¨)"
                        value={amount}
                        onChange={(e) => setAmount(e.target.value)}
                        className="w-full p-3 border border-gray-300 rounded-2xl mb-4 text-lg"
                      />
                      
                      <input
                        type="text"
                        placeholder="Description de l'achat"
                        value={description}
                        onChange={(e) => setDescription(e.target.value)}
                        className="w-full p-3 border border-gray-300 rounded-2xl mb-6"
                      />
                      
                      <div className="flex space-x-3">
                        <button
                          onClick={() => setShowExpense(false)}
                          className="flex-1 bg-gray-200 text-gray-800 p-3 rounded-2xl font-medium"
                        >
                          Annuler
                        </button>
                        <button
                          onClick={handleExpense}
                          className="flex-1 bg-red-500 text-white p-3 rounded-2xl font-medium"
                        >
                          Confirmer
                        </button>
                      </div>
                    </div>
                  </div>
                )}
              </div>
            </div>
          );
        };

        // Rendu de l'application
        ReactDOM.render(<PocketMoneyApp />, document.getElementById('root'));
    </script>
</body>
</html>
